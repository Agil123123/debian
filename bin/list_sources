#!/bin/bash

# List <package, version, .dsc> pairs found in a given Debian (source) mirror.
#
# Output format: "PACKAGE\tVERSION\tDSC\n"
#
# By default, only list the triple corresponding to the most recent package,
# according to the version. Pass --all to list all entries.

# Depends: dctrl-tools

root="/srv/sources.debian.org"
source "$root/etc/config.sh"

list_all="no"

if [ "$1" = "-a" -o "$1" = "--all" ] ; then
    shift
    list_all="yes"
fi

parse_dsc() {
    files_done="no"
    dsc="NONE"
    while [ "$files_done" = "no" ] ; do
        read hash size file        # line(s) "40bf5c1792a2a2555f2fc6edd2314005 1085 hello_1.2-3.dsc
        if [ -z "$hash" ] ; then   # line "\n"
            files_done="yes"
        elif [ "${file: -3:3}" = "dsc" ] ; then
            dsc="$mirror_dir/$directory/$file"
        fi
    done
}

emit() {
    echo -e "$prev_package\\t$prev_version\\t$prev_dsc"
}

# find "$mirror_dir/dists/unstable/contrib" -type f -name Sources.gz | \

find "$mirror_dir/dists/unstable/" -type f -name Sources.gz | \
while read Sources ; do
    prev_package=""
    prev_version=""
    prev_dsc=""
    gunzip -c $Sources | \
    sort-dctrl -k Package,Version:v | \
    grep-dctrl -s Package,Version,Directory,Files '' - | \
    {
        while read key package ; do    # line "Package: foo\n"
            read _key version          # line "Version: 1.2-3\n"
            read _key directory        # line "Directory: pool/main/h/hello\n"
            read _key                  # line "Files:\n"
            parse_dsc
            if [ "$list_all" = "yes" -a -n "$prev_package" ] ; then
                emit
            elif [ "$package" != "$prev_package" -a -n "$prev_package" ] ; then
                emit
            fi
            prev_package="$package"
            prev_version="$version"
            prev_dsc="$dsc"
        done
        emit
    }
done

