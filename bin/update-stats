#!/bin/bash

# Copyright (C) 2011-2013  Stefano Zacchiroli <zack@upsilon.cc>
#
# This file is part of Debsources.
#
# Debsources is free software: you can redistribute it and/or modify it under
# the terms of the GNU Affero General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more
# details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

rrd="rrdtool"

cache_dir="$1"
if [ -z "$cache_dir" ] ; then
    echo "Usage: update-stats CACHE_DIR"
    exit 2
fi

raw_stats="${cache_dir}/stats.data"
rrd_data="${cache_dir}/size.rrd"
rrd_size_graph="${cache_dir}/size.png"

update_rrd() {
    size=$(grep '^size.du[[:blank:]]' $raw_stats | cut -f 2)

    if ! which $rrd > /dev/null ; then
	return
    fi
    if ! [ -f "$rrd_data" ] ; then
	# take samples 4 times a day starting from 1 second ago (to allow
	# immediately injecting a data point), then keep:
	# - 4 times a day for 1 year
	# - daily samples for 10 years
        # - weekly samples for 20 years
	$rrd create "$rrd_data" \
	    --start $(( $(date +%s) - 1 )) \
	    --step 21600 \
	    DS:size:GAUGE:43200:0:U \
	    RRA:AVERAGE:0.5:1:1460 \
	    RRA:AVERAGE:0.5:4:3650 \
	    RRA:AVERAGE:0.5:28:1040
    fi
    if [ "$dry_run" != "yes" ] ; then
	$rrd update "$rrd_data" $(date +%s):"$size"
    fi
}

update_graphs() {
    local flags="--end now"
    flags="$flags --width 400 --height 150 -v bytes"
    flags="$flags DEF:kbytes=${rrd_data}:size:AVERAGE"
    flags="$flags CDEF:bytes=kbytes,1000,*"
    flags="$flags LINE2:bytes#FF0000"

    local statsdir="${cache_dir}/stats"
    test -d "$statsdir" || mkdir -p "$statsdir"

    if [ "$dry_run" != "yes" ] ; then
	$rrd graph ${statsdir}/size-1m.png \
	    --title "disk usage for the last month" \
	    --start end-1m --step 21600 \
	    ${flags}
	$rrd graph ${statsdir}/size-1y.png \
	    --title "disk usage for the last year" \
	    --start end-1y --step 86400 \
	    ${flags}
	$rrd graph ${statsdir}/size-5y.png \
	    --title "disk usage for the last 5 years" \
	    --start end-5y --step 432000 \
	    ${flags}
	$rrd graph ${statsdir}/size-20y.png \
	    --title "disk usage for the last 20 years" \
	    --start end-20y --step 1728000 \
	    ${flags}
    fi
}

main() {
    update_rrd
    update_graphs > /dev/null
}

main
