#!/bin/bash

# Extract a given .dsc into the source repository.
#
# A .dsc will be extracted only if needed.
#
# Usage: extract-source [OPTION]... PACKAGE VERSION DSC_FILE DEST_DIR
# Options:
#     -q/--quiet    suppress all (non-error) output

root="/srv/debsources"
source "$root/etc/config.sh"
source "$root/bin/lib.sh"

if [ "$1" = "-q" -o "$1" = "--quiet" ] ; then
    shift
    verbose="0"
fi

package="$1"    # e.g.: "zodb"
version="$2"    # e.g.: "1:3.9.7-2"
dsc="$3"        # e.g.: "/srv/debian-mirror/pool/main/z/zodb/zodb_3.9.7-2.dsc"
dest="$4"       # e.g.: "/srv/debsources/sources/main/z/zodb/1:3.9.7-2"

if [ -z "$package" -o -z "$version" -o -z "$dsc" -o -z "$dest" -o ! -f "$dsc" ] ; then
    echo "Usage: extract-source [OPTION]... PACKAGE VERSION DSC_FILE DEST_DIR"
    exit 1
fi

base=$(basename $dsc)    # e.g.: "dosemu_1.4.0+svn.2010-1.dsc"
vpkgdir="$dest"

if [ -f "$vpkgdir/$base.done" ] ; then    # already extracted, avoid re-extraction
    exit 0
else
    info "extracting $base ..."
    if [ "$dry_run" != "yes" ] ; then
	mkdir -p "$vpkgdir"
	(cd "$vpkgdir" && \
            dpkg-source --no-copy --no-check -x "$dsc" &> "$base.log" && \
            chgrp -R "$gid" . && \
            touch "$base.done")
    fi
fi
