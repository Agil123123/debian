#!/bin/bash

# Depends: apache2-utils (for httxt2dbm)

root="/srv/debsources"
source "$root/etc/config.sh"
source "$root/bin/lib.sh"

export PATH="$PATH:/usr/sbin"	# httxt2dbm (currently) lives in sbin

update_mirror() {
    # update source mirror
    info "update-debsources: updating source mirror..."
    ${root}/bin/debian-source-mirror
}

# result: fill $sources_list_new with a path to new source packages list
list_sources() {
    info "update-debsources: listing available source packages..."

    # note: no risk of sub-second race here, thanks to $lockfile
    sources_list_new="${sources_list}.$(date +%s)"
    if ! $bindir/list-sources --all > "${sources_list_new}" ; then
	err "cannot list available source packages. Abort." 2
    fi
    chmod 664 "${sources_list_new}"
    chgrp $gid "${sources_list_new}"
}

extract_sources() {
    # extract all source packages
    local srclist="$1"
    info "update-debsources: extracting source packages..."
    ${root}/bin/extract-all "$srclist"
}

garbage_collect() {
    # extract all source packages
    local srclist="$1"
    info "update-debsources: garbage collection..."
    ${root}/bin/gc "$srclist"
}

update_maps() {
    # update maps, indexes, and co.
    # TODO BUG: update_maps is currently not atomic, use a symlink (although
    # it's not *such* a big deal, given it's currently very fast)
    local srclist="$1"
    info "update-debsources: creating http redirection map"
    ${root}/bin/srclist2redirmap < "$srclist" > "$sources_map"
    httxt2dbm -i "$sources_map" -o "$sources_dbm"
    chmod 664 "$sources_dbm"
}

main() {
    info "update-debsources: starting at $(date)"

    if [ -f "$lockfile" ] ; then
	pid=$(head "$lockfile")
	if ! ps "$pid" > /dev/null ; then
	    info "update-debsources: remove stale lockfile for pid '$pid'"
	    rm -f "$lockfile"
	else
	    err "lockfile found. Abort" 2
	fi
    fi
    echo $$ > "$lockfile"

    update_mirror
    list_sources	# fill $sources_list_new
    extract_sources "$sources_list_new"
    if [ ! -L "$sources_list" ] ; then	# clean up if non symlink
	rm -f "$sources_list"
    else
	sources_list_old=$(readlink "$sources_list")
    fi
    ln -fs "$sources_list_new" "$sources_list"	# atomically switch symlink
    if [ -n "$sources_list_old" ] ; then
	rm -f "$sources_list_old"
    fi
    update_maps "$sources_list"
    garbage_collect "$sources_list"

    rm -f "$lockfile"
    info "update-debsources: all done at $(date)"
}

main >> $logfile 2>&1 || echo "update-debsources returned non 0 exit code"
