#!/bin/bash

# Depends: apache2-utils (for httxt2dbm)

root="/srv/debsources"
source "$root/etc/config.sh"
source "$root/bin/lib.sh"

export PATH="$PATH:/usr/sbin"	# httxt2dbm (currently) lives in sbin

update_mirror() {
    # update source mirror
    info "update-debsources: updating source mirror"
    ${root}/bin/debian-source-mirror
}

list_sources() {
    info "listing available source packages..."

    tmp_list=$(mktemp --tmpdir debsources.XXXXXXXXXX)
    trap "rm -f ${tmp_list}" EXIT

    if ! $bindir/list-sources --all > $tmp_list ; then
	err "cannot list available source packages. Abort." 2
    fi
    if [ -f "$sources_list" ] ; then
	mv "$sources_list" "${sources_list}.old"
    fi
    mv "$tmp_list" "$sources_list"
    chmod 664 "$sources_list"
    chgrp $gid "$sources_list"
}

extract_sources() {
    # extract all source packages
    info "update-debsources: extracting source packages"
    ${root}/bin/extract-all
}

garbage_collect() {
    # extract all source packages
    info "update-debsources: garbage collection"
    ${root}/bin/gc
}

update_maps() {
    info "update-debsources: creating http redirection map"
    ${root}/bin/srclist2redirmap < "$sources_list" > "$sources_map"
    httxt2dbm -i "$sources_map" -o "$sources_dbm"
    chmod 664 "$sources_dbm"
}

main() {
    info "update-debsources: starting at $(date)"

    if [ -f "$lockfile" ] ; then
	err "lockfile found. Abort" 2
    fi
    echo $$ > "$lockfile"
    trap "rm -f $lockfile" EXIT

    update_mirror
    list_sources
    extract_sources
    garbage_collect
    update_maps

    info "update-debsources: all done at $(date)"
}

main >> $logfile 2>&1 || echo "update-debsources returned non 0 exit code"
