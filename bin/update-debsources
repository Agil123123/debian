#!/bin/bash

# Depends: apache2-utils (for httxt2dbm)

root="/srv/debsources"
source "$root/etc/config.sh"
source "$root/bin/lib.sh"

export PATH="$PATH:/usr/sbin"	# httxt2dbm (currently) lives in sbin

update_mirror() {
    # update source mirror
    info "update-debsources: updating source mirror"
    ${root}/bin/debian-source-mirror
}

extract_sources() {
    # extract all source packages
    # side effect: update $sources_list
    info "update-debsources: extracting source packages"
    ${root}/bin/extract-all
}

update_maps() {
    info "update-debsources: creating http redirection map"
    ${root}/bin/srclist2redirmap < "$sources_list" > "$sources_map"
    httxt2dbm -i "$sources_map" -o "$sources_dbm"
    chmod 664 "$sources_dbm"
}

main() {
    info "update-debsources: starting at $(date)"

    if [ -f "$lockfile" ] ; then
	err "lockfile found. Abort" 2
    fi
    echo $$ > "$lockfile"
    trap "rm -f $lockfile" EXIT

    update_mirror
    extract_sources
    update_maps

    info "update-debsources: all done at $(date)"
}

main >> $logfile 2>&1 || echo "update-debsources returned non 0 exit code"
