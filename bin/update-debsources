#!/bin/bash

# Copyright (C) 2011-2013  Stefano Zacchiroli <zack@upsilon.cc>
#
# This file is part of Debsources.
#
# Debsources is free software: you can redistribute it and/or modify it under
# the terms of the GNU Affero General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more
# details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Depends: apache2-utils (for httxt2dbm)

source "/srv/debsources/etc/config.sh"
source "${root}/bin/lib.sh"

export PATH="$PATH:/usr/sbin"	# httxt2dbm (currently) lives in sbin

update_mirror() {
    # update source mirror
    info "update-debsources: updating source mirror..."
    ${root}/bin/debian-source-mirror
}

# result: fill $sources_list_new with a path to new source packages list
list_sources() {
    info "update-debsources: listing available source packages..."

    # note: no risk of race here, thanks to $lockfile
    sources_list_new="${sources_list}.new"
    if ! $bindir/list-sources > "${sources_list_new}" ; then
	err "cannot list available source packages. Abort." 2
    fi
    chmod 664 "${sources_list_new}"
    chgrp $gid "${sources_list_new}"
}

extract_sources() {
    # extract all source packages
    local srclist="$1"
    info "update-debsources: extracting source packages..."
    ${root}/bin/extract-all "$srclist"
}

garbage_collect() {
    # get rid of disappeared and expired packages
    local srclist="$1"
    info "update-debsources: garbage collection..."
    ${root}/bin/gc "$srclist"
}

update_db() {
    # update maps, indexes, and co.
    local srclist="$1"
    info "update-debsources: updating indexes..."

    # http redirection maps
    ${root}/bin/srclist2redirmap < "$srclist" > "${sources_map}.new"
    mv "${sources_map}.new" "$sources_map"
    httxt2dbm -i "$sources_map" -o "${sources_dbm}.new"
    chmod 664 "${sources_dbm}.new"
    mv "${sources_dbm}.new" "$sources_dbm"

    # sqlite db and prefixes
    python ${root}/web/scripts/sources2db.py "${sources_sql}.new" "$srclist"
    python ${root}/web/scripts/generate_packages_prefixes.py "${sources_sql}.new" > "${prefixes_file}.new"
    chmod 664 "${sources_sql}.new" "${prefixes_file}.new"

    mv "${sources_sql}.new" "$sources_sql"
    mv "${prefixes_file}.new" "$prefixes_file"

    # timestamp
    date --utc --rfc-2822 > "$timestamp_file"
}

update_stats() {
    info "update-debsources: updating statistics..."
    ${root}/bin/update-stats
}

main() {
    info "update-debsources: starting at $(date)"

    if [ -f "$lockfile" ] ; then
	pid=$(head "$lockfile")
	if ! ps "$pid" > /dev/null ; then
	    info "update-debsources: remove stale lockfile for pid '$pid'"
	    rm -f "$lockfile"
	else
	    err "lockfile found. Abort" 2
	fi
    fi
    echo $$ > "$lockfile"

    update_mirror
    list_sources	# fill $sources_list_new
    if ! [ -f "$sources_list" ] \
	|| ! (diff "$sources_list" "$sources_list_new" > /dev/null)
    then
	extract_sources "$sources_list_new"
	mv "$sources_list_new" "$sources_list"
	update_db "$sources_list"
    else
	info "update-debsources: no changes"
	rm "$sources_list_new"
    fi
    # do GC no matter what: even in case of no changes, we might need to expire
    # some (now) old content
    garbage_collect "$sources_list"
    update_stats

    rm -f "$lockfile"
    info "update-debsources: all done at $(date)"
    echo
}

main >> $logfile 2>&1 || echo "update-debsources returned non 0 exit code"
