#!/bin/bash

# Extract a given .dsc into the source repository.
#
# A .dsc will be extracted only if needed; older extracted sources of the same
# source package, if any, will be deleted (i.e. only the extracted version of
# the most recent source package will be kept). 
#
# Usage: extract_source [OPTION]... PACKAGE VERSION DSC_FILE
# Options:
#     -q/--quiet    suppress all (non-error) output

root="/srv/sources.debian.org"
source "$root/etc/config.sh"

verbose="1"

if [ "$1" = "-q" -o "$1" = "--quiet" ] ; then
    shift
    verbose="0"
fi

package="$1"    # e.g.: "dosemu"
version="$2"    # e.g.: "1.4.0+svn.2010-1"
dsc="$3"        # e.g.: "/srv/debian-mirror/pool/contrib/d/dosemu/dosemu_1.4.0+svn.2010-1.dsc"

if [ -z "$package" -o -z "$version" -o -z "$dsc" -o ! -f "$dsc" ] ; then
    echo "Usage: extract_source [OPTION]... PACKAGE VERSION DSC_FILE"
    exit 1
fi

base=$(basename $dsc)    # e.g.: "dosemu_1.4.0+svn.2010-1.dsc"
dirkey=""                # e.g.: "d" (or "libd" for libraries)
sect=$(echo $dsc | cut -f 5 -d'/')    # e.g.: "contrib"
case "$base" in
    lib*)
        dirkey=${base:0:4}
        ;;
    *)
        dirkey=${base:0:1}
        ;;
esac
pkgdir="$sources_dir/$sect/$dirkey/$package"
vpkgdir="$sources_dir/$sect/$dirkey/$package/$version"

if [ -f "$vpkgdir/$base.done" ] ; then    # already extracted, avoid re-extraction
    exit 0
else
    if [ "$verbose" = "1" ] ; then
        echo "I: extracting $base ..."
    fi
    if [ -d "$pkgdir" ] ; then    # get rid of old versions, if any
        rm -rf "$pkgdir"
    fi
    mkdir -p "$vpkgdir"
    (cd "$vpkgdir" && \
        dpkg-source --no-copy --no-check -x "$dsc" &> "$base.log" && \
        chgrp -R "$gid" . && \
        touch "$base.done")
fi

