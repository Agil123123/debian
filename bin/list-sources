#!/bin/bash

# Copyright (C) 2011-2013  Stefano Zacchiroli <zack@upsilon.cc>
#
# This file is part of Debsources.
#
# Debsources is free software: you can redistribute it and/or modify it under
# the terms of the GNU Affero General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more
# details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# List information about source package found in a given debsources instance
#
# Output format: "PACKAGE\tVERSION\tAREA\tDSC\tDEST\n"
#
# - PACKAGE is the source package name
# - VERSION is the source version
# - AREA is the archive area of origin, i.e. one of main, contrib, non-free
# - DSC is the absolute path to the package .dsc in the source mirror
# - DEST is the absolute path to the package unpacking directory
#
# By default, only list the tuples corresponding to the most recent packages,
# according to the version. Pass --all to list all entries.

# Depends: dctrl-tools

root="/srv/debsources"
source "$root/etc/config.sh"
source "$root/bin/lib.sh"

list_all="no"

if [ "$1" = "-a" -o "$1" = "--all" ] ; then
    shift
    list_all="yes"
fi

parse_dsc() {
    files_done="no"
    dsc="NONE"
    while [ "$files_done" = "no" ] ; do
        read hash size file        # line(s) "40bf5c1792a2a2555f2fc6edd2314005 1085 hello_1.2-3.dsc
        if [ -z "$hash" ] ; then   # line "\n"
            files_done="yes"
        elif [ "${file: -3:3}" = "dsc" ] ; then
            dsc="$mirror_dir/$directory/$file"
        fi
    done
}

emit() {
    echo -e "$package\\t$version\\t$area\\t$dsc\\t$dest"
}

# find "$mirror_dir/dists/unstable/contrib" -type f -name Sources.gz |

src_indexes=$(find "$mirror_dir/dists/" -type f -name Sources.gz)

zcat $src_indexes | \
sort-dctrl -k Package,Version:vr | \
grep-dctrl -s Package,Version,Directory,Files '' - | \
{
    prev_package=""
    prev_version=""
    while read _key package ; do   # line "Package: foo\n"
        read _key version          # line "Version: 1.2-3\n"
        read _key directory        # line "Directory: pool/main/h/hello\n"
        read _key                  # line "Files:\n"
        parse_dsc
        dest="$sources_dir/${directory#*/}/$version"
	area="${directory#*/}"
	area="${area%%/*}"
	if [ "$package" != "$prev_package" ]; then
	    # first of his name, i.e. most recent
	    emit
        elif [ "$list_all" = "yes" -a "$version" != "$prev_version" ] ; then
	    # emit all versions, as requested, but suppress duplicates
	    emit
        fi
        prev_package="$package"
        prev_version="$version"
    done
}

